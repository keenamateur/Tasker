if (!msg.topic || typeof msg.topic !== "string") {
    return null;
}

const topicParts = msg.topic.split('/');
if (topicParts.length < 5 || topicParts[0] !== "gtl") {
    return null;
}

//const deviceParts = topicParts[1].split('_');
//if (deviceParts.length < 2) {
//    return null;
//}

const room = topicParts[2]; //

const allowedRooms = ["Nappali", "Konyha", "Fürdő", "Háló", "Terasz", "Biztonság", "Műhely", "Garázs", "Áram", "Szerver", "Sátor"];

if (!allowedRooms.includes(room)) {
    return null;
}

const tmpdevicename = topicParts[3];

// Configuration
const DEVICE_FILTER_CONFIG = {
    patterns: /(l1|l2)/i, // Matches l1 or l2 in topicParts[4]
    allowedDevices: new Set(["l1", "l2"])
};

// Check conditions
const matchesPattern = DEVICE_FILTER_CONFIG.patterns.test(topicParts[4]); // Check the endpoint (l1/l2)
const isAllowed = DEVICE_FILTER_CONFIG.allowedDevices.has(tmpdevicename); // Check the device name

if (!(matchesPattern || isAllowed)) {
    return null;
}

const avdevicename = `${topicParts[3]}/${topicParts[4]}`; // "TöltőZgb_l1"
const type = "dimmer";

if (!msg.payload || typeof msg.payload !== "object" || !msg.payload.state) {
    return null;
}

let avnewstatus;
if (msg.payload.state === "OFF") {
    avnewstatus = 0;
} else if (msg.payload.state === "ON") {
    // Ensure brightness is defined and valid
    avnewstatus = (msg.payload.brightness !== undefined && msg.payload.brightness !== null)
        ? msg.payload.brightness
        : 100;
} else {
    return null;
}

// additional validation to prevent undefined values
if (avnewstatus === undefined || avnewstatus === null) {
    return null;
}
let port = 1905;
let ip = global.get("con_ip");

if (!ip || typeof ip !== "string" || !ip.match(/^(\d{1,3}\.){3}\d{1,3}$/)) {
    return null;
}


let url = `http://${ip}:${port}`;

return {
    payload: {
        room: room,
        avdevicename: avdevicename,
        avnewstatus: avnewstatus,
        type: type
    },
    url: url,
    _original: {
        topic: msg.topic,
        payload: msg.payload
    }
};
return msg;
